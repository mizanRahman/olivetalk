(function(){var e,t,n=function(e,t){return function(){return e.apply(t,arguments)}};$(document).ready(function(){var t;return t=new e,$("#new_image").submit(function(e){return window.FileList&&FormData?(e.preventDefault(),t.upload_all()):void 0}),$("#image_image").change(function(e){return t.file_list=e.target.files})}),e=function(){function e(){this.do_upload=n(this.do_upload,this),this.authenticity_token=$('meta[name="csrf-token"]').attr("content"),this.form_action=$("#new_image").attr("action"),this.cache_dom()}return e.prototype.cache_dom=function(){return this.error_list=$("#error_list"),this.error_explanation=$("#errorExplanation"),this.upload_progress=$("#upload_progress")},e.prototype.before_upload_all=function(){return this.files=[],this.errors=[],this.total_files=this.file_list.length,this.uploaded=0,this.error_explanation.hide()},e.prototype.upload_all=function(){var e,t,n,r;for(this.before_upload_all(),r=this.file_list,t=0,n=r.length;n>t;t++)e=r[t],this.validate(e),this.files.push(e);return this.errors.length>0?this.render_errors():($("#submit_button").hide(),$(".field").hide(),this.progress("Uploading..."),this.upload_next())},e.prototype.after_upload_all=function(){return $(".save-loader").hide(),this.upload_progress.hide(),this.errors.length>0?this.render_errors():"true"===t("modal")?window.parent.document.getElementById("dialog_frame").contentDocument.location.reload(!0):"true"===t("dialog")?window.parent.location.reload(!0):window.location="/university/refinery/images"},e.prototype.validate=function(e){var t,n;return t=5242880,e.size>t&&this.errors.push(""+e.name+" should be smaller than "+t+" bytes in size"),n=["image/jpeg","image/png","image/gif","image/tiff"],-1===n.indexOf(e.type)?this.errors.push(""+e.name+" should be either a JPG, PNG or GIF"):void 0},e.prototype.upload_next=function(){return 0!==this.files.length&&this.do_upload(this.files[0]),this.total_files>0&&0===this.files.length?this.after_upload_all():void 0},e.prototype.do_upload=function(e){var t,n;return t=new FormData,t.append("image[image]",e),t.append("authenticity_token",this.authenticity_token),n=this,$.ajax({type:"POST",url:this.form_action,data:t,contentType:!1,processData:!1,success:function(){return n.post_success(e)},error:function(t){return n.post_error(e,t.responseText)}})},e.prototype.after_do_upload=function(e){return this.files.remove(e),this.upload_next()},e.prototype.post_success=function(e){return this.progress(e.name+" uploaded"),this.update_progress(e),this.after_do_upload(e)},e.prototype.post_error=function(e,t){var n,r,i;for(t=JSON.parse(t).image,this.update_progress(e,t),r=0,i=t.length;i>r;r++)n=t[r],this.errors.push(""+e.name+": "+n);return this.after_do_upload(e)},e.prototype.render_errors=function(){var e,t,n,r;for($(".save-loader").hide(),this.error_list.html(""),r=this.errors,t=0,n=r.length;n>t;t++)e=r[t],this.error_list.append("<li>"+e+"</li>");return this.error_explanation.show()},e.prototype.update_progress=function(e,t){var n;return null==t&&(t=null),this.uploaded++,n=t||"Last upload complete: "+e.name,this.progress(""+this.uploaded+"/"+this.total_files+" uploaded | "+n)},e.prototype.progress=function(e){return this.upload_progress.html(e)},e}(),Array.prototype.remove=function(e){var t,n;return(t=this.indexOf(e))>-1?([].splice.apply(this,[t,t-t+1].concat(n=[])),n):void 0},t=function(e){var t,n,r;return e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),n="[\\?&]"+e+"=([^&#]*)",t=new RegExp(n),r=t.exec(window.location.search),null==r?"":decodeURIComponent(r[1].replace(/\+/g," "))}}).call(this);